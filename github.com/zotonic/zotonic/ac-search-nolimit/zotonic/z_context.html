<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>z_context (zotonic) -  (Erlang Documentation)</title>
    <link href="/erldocs.css" type="text/css" rel="stylesheet"/>
    <link href="/search.xml" rel="search" type="application/opensearchdescription+xml" title="erldocs"/>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-54292016-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="sidebar" class="inactive">
      <input type="text" id="search" autocomplete="off" placeholder="press TAB to search"/>
      <ul id="results"> </ul>
    </div>

    <div id="content">
      <div style="margin:0px; padding:10px 20px;">
        

<h1>z_context</h1>
<h2 class="modsummary">Request context for Zotonic request evaluation.</h2>
<div class="description">
<p>Request context for Zotonic request evaluation.</p></div>
<div id="types" class="category"><h4><a href="#types">Types</a></h4><hr />
    <div class="type"><h3 id="type-wm_dict">wm_dict() = dict()</h3></div>
    <div class="type"><h3 id="type-wm_gb_tree">wm_gb_tree() = gb_tree()</h3></div></div>
<div id="functions" class="category"><h4><a href="#functions">Functions</a></h4><hr />
<div class="function">
<h3 id="new/1">new(Context::HostDescr) -&gt; Context2</h3>

<ul class="type">
<li><code>HostDescr = Context | atom() | ReqData</code></li></ul>
<div class="description">

<p>Return a new empty context, no request is initialized.</p>
</div></div>
<div class="function">
<h3 id="new/2">new(Host, Lang) -&gt; term()
</h3>


<div class="description">

<p>Create a new context record for a host with a certain language.</p>
</div></div>
<div class="function">
<h3 id="new_tests/0">new_tests() -&gt; term()
</h3>


<div class="description">

<p>Create a new context used when testing parts of zotonic</p>
</div></div>
<div class="function">
<h3 id="site/1">site(Context::wm_reqdata) -&gt; atom()</h3>


<div class="description">

<p>Maps the host in the request to a site in the sites folder.</p>
</div></div>
<div class="function">
<h3 id="hostname/1">hostname(Context) -&gt; string()</h3>


<div class="description">

<p>Return the preferred hostname from the site configuration</p>
</div></div>
<div class="function">
<h3 id="hostname_port/1">hostname_port(Context) -&gt; string()</h3>


<div class="description">

<p>Return the preferred hostname, including port, from the site configuration</p>
</div></div>
<div class="function">
<h3 id="is_request/1">is_request(Context) -&gt; term()
</h3>


<div class="description">

<p>Check if the current context is a request context</p>
</div></div>
<div class="function">
<h3 id="prune_for_spawn/1">prune_for_spawn(Context) -&gt; term()
</h3>


<div class="description">

<p>Minimal prune, for ensuring that the context can safely used in two processes</p>
</div></div>
<div class="function">
<h3 id="prune_for_async/1">prune_for_async(Context) -&gt; term()
</h3>


<div class="description">

<p>Make the context safe to use in a async message. This removes buffers and the db transaction.</p>
</div></div>
<div class="function">
<h3 id="prune_for_template/1">prune_for_template(Context) -&gt; term()
</h3>


<div class="description">

<p>Cleanup a context for the output stream</p>
</div></div>
<div class="function">
<h3 id="prune_for_database/1">prune_for_database(Context) -&gt; term()
</h3>


<div class="description">

<p>Cleanup a context so that it can be used exclusively for database connections</p>
</div></div>
<div class="function">
<h3 id="prune_for_scomp/2">prune_for_scomp(VisibleFor, Context) -&gt; term()
</h3>


<div class="description">

<p>Cleanup a context for cacheable scomp handling.  Resets most of the accumulators to prevent duplicating
  between different (cached) renderings.</p>
</div></div>
<div class="function">
<h3 id="abs_url/1">abs_url(Url::iolist(), Context) -&gt; binary()</h3>


<div class="description">

<p>Make the url an absolute url by prepending the hostname.</p>
</div></div>
<div class="function">
<h3 id="site_protocol/1">site_protocol(Context) -&gt; term()
</h3>


<div class="description">

<p>Fetch the protocol for absolute urls referring to the site (defaults to http).
       Useful when the site is behind a https proxy.</p>
</div></div>
<div class="function">
<h3 id="pickle/1">pickle(Context) -&gt; tuple()</h3>


<div class="description">

<p>Pickle a context for storing in the database</p>
</div></div>
<div class="function">
<h3 id="depickle/1">depickle(X1) -&gt; term()
</h3>


<div class="description">

<p>Depickle a context for restoring from a database</p>
</div></div>
<div class="function">
<h3 id="output/1">output(B::list(), Context) -&gt; {io_list(), Context}</h3>


<div class="description">

<p>Replace the contexts in the output with their rendered content and collect all scripts</p>
</div></div>
<div class="function">
<h3 id="combine_results/2">combine_results(C1::Context1, C2::Context2) -&gt; Context</h3>


<div class="description">

<p>Merge the scripts and the rendered content of two contexts into Context1</p>
</div></div>
<div class="function">
<h3 id="merge_scripts/2">merge_scripts(C::Context, Acc::ContextAcc) -&gt; Context</h3>


<div class="description">

<p>Merge the scripts from context C into the context accumulator, used when collecting all scripts in an output stream</p>
</div></div>
<div class="function">
<h3 id="clean_scripts/1">clean_scripts(C::Context) -&gt; Context</h3>


<div class="description">

<p>Remove all scripts from the context</p>
</div></div>
<div class="function">
<h3 id="copy_scripts/2">copy_scripts(From, Context) -&gt; Context</h3>


<div class="description">

<p>Overwrite the scripts in Context with the scripts in From</p>
</div></div>
<div class="function">
<h3 id="continue_session/1">continue_session(Context) -&gt; term()
</h3>


<div class="description">

<p>Continue an existing session, if the session id is in the request.</p>
</div></div>
<div class="function">
<h3 id="has_session_page/1">has_session_page(Context) -&gt; term()
</h3>


<div class="description">

<p>Check if the current context has a session page attached</p>
</div></div>
<div class="function">
<h3 id="has_session/1">has_session(Context) -&gt; term()
</h3>


<div class="description">

<p>Check if the current context has a session attached</p>
</div></div>
<div class="function">
<h3 id="ensure_all/1">ensure_all(Context) -&gt; term()
</h3>


<div class="description">

<p>Ensure session and page session. Fetches and parses the query string.</p>
</div></div>
<div class="function">
<h3 id="ensure_session/1">ensure_session(Context) -&gt; term()
</h3>


<div class="description">

<p>Ensure that we have a session, start a new session process when needed</p>
</div></div>
<div class="function">
<h3 id="ensure_qs/1">ensure_qs(Context) -&gt; term()
</h3>


<div class="description">

<p>Ensure that we have parsed the query string, fetch body if necessary</p>
</div></div>
<div class="function">
<h3 id="get_reqdata/1">get_reqdata(Context) -&gt; #wm_reqdata{}</h3>


<div class="description">

<p>Return the webmachine request data of the context</p>
</div></div>
<div class="function">
<h3 id="set_reqdata/2">set_reqdata(ReqData, Context) -&gt; #wm_reqdata{}</h3>


<div class="description">

<p>Set the webmachine request data of the context</p>
</div></div>
<div class="function">
<h3 id="get_controller_module/1">get_controller_module(Context) -&gt; term()</h3>


<div class="description">

<p>Get the resource module handling the request.</p>
</div></div>
<div class="function">
<h3 id="set_controller_module/1">set_controller_module(Module::atom(), Context) -&gt; NewContext</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="get_q/1">get_q(Key::string(), Context) -&gt; Value::string() | undefined</h3>


<div class="description">

<p>Get a request parameter, either from the query string or the post body.  Post body has precedence over the query string.</p>
</div></div>
<div class="function">
<h3 id="get_q/1-1">get_q(Key::string(), Context, Default) -&gt; Value::string()</h3>


<div class="description">

<p>Get a request parameter, either from the query string or the post body.  Post body has precedence over the query string.</p>
</div></div>
<div class="function">
<h3 id="get_q_all/1">get_q_all(Context) -&gt; [{Key::string(), [Values]}]</h3>


<div class="description">

<p>Get all parameters.</p>
</div></div>
<div class="function">
<h3 id="get_q_all/1-1">get_q_all(Key::string(), Context) -&gt; [Values]</h3>


<div class="description">

<p>Get the all the parameters with the same name, returns the empty list when non found.</p>
</div></div>
<div class="function">
<h3 id="get_q_all_noz/1">get_q_all_noz(Context) -&gt; [{Key::string(), [Values]}]</h3>


<div class="description">

<p>Get all query/post args, filter the zotonic internal args.</p>
</div></div>
<div class="function">
<h3 id="get_q_validated/2">get_q_validated(Keys::Key, Context) -&gt; Value</h3>


<div class="description">

<p>Fetch a query parameter and perform the validation connected to the parameter. An exception {not_validated, Key}
       is thrown when there was no validator, when the validator is invalid or when the validation failed.</p>
</div></div>
<div class="function">
<h3 id="add_script_session/1">add_script_session(Context) -&gt; term()
</h3>


<div class="description">

<p>Add the script from the context to all pages of the session.</p>
</div></div>
<div class="function">
<h3 id="add_script_page/1">add_script_page(Context) -&gt; term()
</h3>


<div class="description">

<p>Add the script from the context to the page in the user agent.</p>
</div></div>
<div class="function">
<h3 id="add_script_session/2">add_script_session(Script, Context) -&gt; term()
</h3>


<div class="description">

<p>Add a script to the all pages of the session. Used for comet feeds.</p>
</div></div>
<div class="function">
<h3 id="add_script_page/2">add_script_page(Script, Context) -&gt; term()
</h3>


<div class="description">

<p>Add a script to the page in the user agent.  Used for comet feeds.</p>
</div></div>
<div class="function">
<h3 id="spawn_link_session/4">spawn_link_session(Module, Func, Args, Context) -&gt; term()
</h3>


<div class="description">

<p>Spawn a new process, link it to the session process.</p>
</div></div>
<div class="function">
<h3 id="spawn_link_page/4">spawn_link_page(Module, Func, Args, Context) -&gt; term()
</h3>


<div class="description">

<p>Spawn a new process, link it to the page process.  Used for comet feeds.</p>
</div></div>
<div class="function">
<h3 id="get_value/1">get_value(Key::string(), Context) -&gt; Value | undefined</h3>


<div class="description">

<p>Find a key in the context, page, session or persistent state.</p>
</div></div>
<div class="function">
<h3 id="persistent_id/1">persistent_id(Context) -&gt; term()
</h3>


<div class="description">

<p>Ensure that we have an id for the visitor</p>
</div></div>
<div class="function">
<h3 id="set_persistent/3">set_persistent(Key, Value, Context) -&gt; Context</h3>


<div class="description">

<p>Set the value of the visitor variable Key to Value</p>
</div></div>
<div class="function">
<h3 id="get_persistent/2">get_persistent(Key, Context) -&gt; Value</h3>


<div class="description">

<p>Fetch the value of the visitor variable Key</p>
</div></div>
<div class="function">
<h3 id="set_session/3">set_session(Key, Value, Context) -&gt; Context</h3>


<div class="description">

<p>Set the value of the session variable Key to Value</p>
</div></div>
<div class="function">
<h3 id="get_session/2">get_session(Key, Context) -&gt; Value</h3>


<div class="description">

<p>Fetch the value of the session variable Key</p>
</div></div>
<div class="function">
<h3 id="get_session/3">get_session(Key, Context, DefaultValue) -&gt; Value</h3>


<div class="description">

<p>Fetch the value of the session variable Key, falling back to default.</p>
</div></div>
<div class="function">
<h3 id="incr_session/3">incr_session(Key, Value::Increment, Context) -&gt; {NewValue, NewContext}</h3>


<div class="description">

<p>Increment the session variable Key</p>
</div></div>
<div class="function">
<h3 id="set_page/3">set_page(Key, Value, Context) -&gt; Context</h3>


<div class="description">

<p>Set the value of the page variable Key to Value</p>
</div></div>
<div class="function">
<h3 id="get_page/2">get_page(Key, Context) -&gt; Value</h3>


<div class="description">

<p>Fetch the value of the page variable Key</p>
</div></div>
<div class="function">
<h3 id="incr_page/3">incr_page(Key, Value::Increment, Context) -&gt; {NewValue, NewContext}</h3>


<div class="description">

<p>Increment the page variable Key</p>
</div></div>
<div class="function">
<h3 id="set/3">set(Key, Value, Context) -&gt; Context</h3>


<div class="description">

<p>Set the value of the context variable Key to Value</p>
</div></div>
<div class="function">
<h3 id="set/2">set(PropList, Context) -&gt; Context</h3>


<div class="description">

<p>Set the value of the context variables to all {Key, Value} properties.</p>
</div></div>
<div class="function">
<h3 id="get/2">get(Key, Context) -&gt; Value | undefined</h3>


<div class="description">

<p>Fetch the value of the context variable Key, return undefined when Key is not found.</p>
</div></div>
<div class="function">
<h3 id="get/3">get(Key, Context, Default) -&gt; Value | Default</h3>


<div class="description">

<p>Fetch the value of the context variable Key, return Default when Key is not found.</p>
</div></div>
<div class="function">
<h3 id="get_all/1">get_all(Context) -&gt; PropList</h3>


<div class="description">

<p>Return a proplist with all context variables.</p>
</div></div>
<div class="function">
<h3 id="incr/3">incr(Key, Value::Increment, Context) -&gt; {NewValue, NewContext}</h3>


<div class="description">

<p>Increment the context variable Key</p>
</div></div>
<div class="function">
<h3 id="language/1">language(Context) -&gt; term()
</h3>


<div class="description">

<p>Return the selected language of the Context</p>
</div></div>
<div class="function">
<h3 id="set_language/1">set_language(Lang::atom(), Context::context()) -&gt; context()</h3>


<div class="description">

<p>Set the language of the context.</p>
</div></div>
<div class="function">
<h3 id="set_resp_header/3">set_resp_header(Header, Value, Context) -&gt; NewContext</h3>


<div class="description">

<p>Set a response header for the request in the context.</p>
</div></div>
<div class="function">
<h3 id="get_resp_header/2">get_resp_header(Header, Context) -&gt; Value</h3>


<div class="description">

<p>Get a response header</p>
</div></div>
<div class="function">
<h3 id="get_req_header/2">get_req_header(Header, Context) -&gt; Value</h3>


<div class="description">

<p>Get a request header. The header MUST be in lower case.</p>
</div></div>
<div class="function">
<h3 id="get_req_path/1">get_req_path(Context) -&gt; list()</h3>


<div class="description">

<p>Return the request path</p>
</div></div>
<div class="function">
<h3 id="cookie_domain/1">cookie_domain(Context) -&gt; list() | undefined</h3>


<div class="description">

<p>Fetch the cookie domain, defaults to 'undefined' which will equal the domain
  to the domain of the current request.</p>
</div></div>
<div class="function">
<h3 id="document_domain/1">document_domain(Context) -&gt; term()
</h3>


<div class="description">

<p>The document domain used for cross domain iframe javascripts</p>
</div></div>
<div class="function">
<h3 id="streamhost/1">streamhost(Context) -&gt; list()</h3>


<div class="description">

<p>Fetch the domain and port for stream (comet/websocket) connections</p>
</div></div>
<div class="function">
<h3 id="websockethost/1">websockethost(Context) -&gt; list()</h3>


<div class="description">

<p>Fetch the domain and port for websocket connections</p>
</div></div>
<div class="function">
<h3 id="has_websockethost/1">has_websockethost(Context) -&gt; bool()</h3>


<div class="description">

<p>Return true iff this site has a separately configured websockethost</p>
</div></div>
<div class="function">
<h3 id="set_nocache_headers/1">set_nocache_headers(Context::#context{}) -&gt; #context{}</h3>


<div class="description">

<p>Some user agents have too aggressive client side caching.
  These headers prevent the caching of content on the user agent iff
  the content generated has a session. You can prevent addition of
  these headers by not calling z_context:ensure_session/1, or
  z_context:ensure_all/1.</p>
</div></div>
<div class="function">
<h3 id="set_noindex_header/1">set_noindex_header(Context::#context{host=any(), wm_reqdata=#wm_reqdata{socket=any(), metadata=wm_dict(), range=any(), peer=ip_address() (see module inet), bodyfetch=any(), log_data=any(), method=undefined | method() (see module wrq), scheme=undefined | scheme() (see module wrq), version=undefined | version() (see module wrq), disp_path=any(), path=undefined | string(), raw_path=undefined | string(), path_info=undefined | wm_dict(), path_tokens=undefined | [string()], app_root=undefined | string(), response_code=undefined | pos_integer(), max_recv_body=undefined | pos_integer(), req_cookie=undefined | string(), req_qs=undefined | string(), req_headers=undefined | wm_gb_tree(), req_body=any(), resp_redirect=undefined | boolean(), resp_headers=any(), resp_content_encoding=undefined | string(), resp_transfer_encoding=undefined | {string(), function()}, resp_content_type=undefined | string(), resp_chosen_charset=undefined | string(), resp_body=undefined | any(), is_range_ok=boolean(), host_tokens=undefined | [string()], port=undefined | port_number() (see module inet), cache=list()} | undefined, controller_module=atom(), session_pid=pid() | undefined, page_pid=pid() | undefined, page_id=string() | undefined, ua_class=device_type() (see module ua_classifier) | undefined, depcache=any(), notifier=any(), session_manager=any(), dispatcher=any(), template_server=any(), scomp_server=any(), dropbox_server=any(), pivot_server=any(), module_indexer=any(), translation_table=any(), dbc=pid() | undefined, language=atom(), acl=any(), user_id=integer() | undefined, updates=any(), actions=any(), content_scripts=any(), scripts=any(), wire=any(), validators=any(), render=any(), props=any()}) -&gt; #context{host=any(), wm_reqdata=#wm_reqdata{socket=any(), metadata=wm_dict(), range=any(), peer=ip_address() (see module inet), bodyfetch=any(), log_data=any(), method=undefined | method() (see module wrq), scheme=undefined | scheme() (see module wrq), version=undefined | version() (see module wrq), disp_path=any(), path=undefined | string(), raw_path=undefined | string(), path_info=undefined | wm_dict(), path_tokens=undefined | [string()], app_root=undefined | string(), response_code=undefined | pos_integer(), max_recv_body=undefined | pos_integer(), req_cookie=undefined | string(), req_qs=undefined | string(), req_headers=undefined | wm_gb_tree(), req_body=any(), resp_redirect=undefined | boolean(), resp_headers=any(), resp_content_encoding=undefined | string(), resp_transfer_encoding=undefined | {string(), function()}, resp_content_type=undefined | string(), resp_chosen_charset=undefined | string(), resp_body=undefined | any(), is_range_ok=boolean(), host_tokens=undefined | [string()], port=undefined | port_number() (see module inet), cache=list()} | undefined, controller_module=atom(), session_pid=pid() | undefined, page_pid=pid() | undefined, page_id=string() | undefined, ua_class=device_type() (see module ua_classifier) | undefined, depcache=any(), notifier=any(), session_manager=any(), dispatcher=any(), template_server=any(), scomp_server=any(), dropbox_server=any(), pivot_server=any(), module_indexer=any(), translation_table=any(), dbc=pid() | undefined, language=atom(), acl=any(), user_id=integer() | undefined, updates=any(), actions=any(), content_scripts=any(), scripts=any(), wire=any(), validators=any(), render=any(), props=any()}</h3>


<div class="description">

<p>Set the noindex header if the config is set, or the webmachine resource opt is set.</p>
</div></div>
<div class="function">
<h3 id="set_noindex_header/1-1">set_noindex_header(Force::term(), Context::#context{host=any(), wm_reqdata=#wm_reqdata{socket=any(), metadata=wm_dict(), range=any(), peer=ip_address() (see module inet), bodyfetch=any(), log_data=any(), method=undefined | method() (see module wrq), scheme=undefined | scheme() (see module wrq), version=undefined | version() (see module wrq), disp_path=any(), path=undefined | string(), raw_path=undefined | string(), path_info=undefined | wm_dict(), path_tokens=undefined | [string()], app_root=undefined | string(), response_code=undefined | pos_integer(), max_recv_body=undefined | pos_integer(), req_cookie=undefined | string(), req_qs=undefined | string(), req_headers=undefined | wm_gb_tree(), req_body=any(), resp_redirect=undefined | boolean(), resp_headers=any(), resp_content_encoding=undefined | string(), resp_transfer_encoding=undefined | {string(), function()}, resp_content_type=undefined | string(), resp_chosen_charset=undefined | string(), resp_body=undefined | any(), is_range_ok=boolean(), host_tokens=undefined | [string()], port=undefined | port_number() (see module inet), cache=list()} | undefined, controller_module=atom(), session_pid=pid() | undefined, page_pid=pid() | undefined, page_id=string() | undefined, ua_class=device_type() (see module ua_classifier) | undefined, depcache=any(), notifier=any(), session_manager=any(), dispatcher=any(), template_server=any(), scomp_server=any(), dropbox_server=any(), pivot_server=any(), module_indexer=any(), translation_table=any(), dbc=pid() | undefined, language=atom(), acl=any(), user_id=integer() | undefined, updates=any(), actions=any(), content_scripts=any(), scripts=any(), wire=any(), validators=any(), render=any(), props=any()}) -&gt; #context{host=any(), wm_reqdata=#wm_reqdata{socket=any(), metadata=wm_dict(), range=any(), peer=ip_address() (see module inet), bodyfetch=any(), log_data=any(), method=undefined | method() (see module wrq), scheme=undefined | scheme() (see module wrq), version=undefined | version() (see module wrq), disp_path=any(), path=undefined | string(), raw_path=undefined | string(), path_info=undefined | wm_dict(), path_tokens=undefined | [string()], app_root=undefined | string(), response_code=undefined | pos_integer(), max_recv_body=undefined | pos_integer(), req_cookie=undefined | string(), req_qs=undefined | string(), req_headers=undefined | wm_gb_tree(), req_body=any(), resp_redirect=undefined | boolean(), resp_headers=any(), resp_content_encoding=undefined | string(), resp_transfer_encoding=undefined | {string(), function()}, resp_content_type=undefined | string(), resp_chosen_charset=undefined | string(), resp_body=undefined | any(), is_range_ok=boolean(), host_tokens=undefined | [string()], port=undefined | port_number() (see module inet), cache=list()} | undefined, controller_module=atom(), session_pid=pid() | undefined, page_pid=pid() | undefined, page_id=string() | undefined, ua_class=device_type() (see module ua_classifier) | undefined, depcache=any(), notifier=any(), session_manager=any(), dispatcher=any(), template_server=any(), scomp_server=any(), dropbox_server=any(), pivot_server=any(), module_indexer=any(), translation_table=any(), dbc=pid() | undefined, language=atom(), acl=any(), user_id=integer() | undefined, updates=any(), actions=any(), content_scripts=any(), scripts=any(), wire=any(), validators=any(), render=any(), props=any()}</h3>


<div class="description">

<p>Set the noindex header if the config is set, the webmachine resource opt is set or Force is set.</p>
</div></div>
<div class="function">
<h3 id="set_cookie/3">set_cookie(Key, Value, Context) -&gt; term()
</h3>


<div class="description">

<p>Set a cookie value with default options.</p>
</div></div>
<div class="function">
<h3 id="set_cookie/4">set_cookie(Key, Value, Options, Context) -&gt; term()
</h3>


<div class="description">

<p>Set a cookie value with cookie options.</p>
</div></div>
<div class="function">
<h3 id="get_cookie/2">get_cookie(Key, Context) -&gt; term()
</h3>


<div class="description">

<p>Read a cookie value from the current request.</p>
</div></div></div>

<authors>

<aname>Marc Worrell</aname>
<email>marc@worrell.nl</email></authors>
      </div>
  </div>

    <script type="text/javascript">
      var CURRENT_ROOT = "../";
    </script>

    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="../erldocs_index.js"></script>
    <script type="text/javascript" src="/erldocs.js"></script>
  </body>
</html>
