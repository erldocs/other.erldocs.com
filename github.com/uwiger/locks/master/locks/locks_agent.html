<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>locks_agent (locks) -  (Erlang Documentation)</title>
    <link href="/erldocs.css" type="text/css" rel="stylesheet"/>
    <link href="/search.xml" rel="search" type="application/opensearchdescription+xml" title="erldocs"/>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-54292016-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="sidebar" class="inactive">
      <input type="text" id="search" autocomplete="off" placeholder="press TAB to search"/>
      <ul id="results"> </ul>
    </div>

    <div id="content">
      <div style="margin:0px; padding:10px 20px;">
        

<h1>locks_agent</h1>
<h2 class="modsummary">Transaction agent for the locks system.</h2>
<div class="description">
<p>Transaction agent for the locks system</p>
 
  <p>This module implements the recommended API for users of the <code>locks</code> system.
  While the <code>locks_server</code> has a low-level API, the <code>locks_agent</code> is the  
part that detects and resolves deadlocks.</p>
 
  <p>The agent runs as a separate process from the client, and monitors the
  client, terminating immediately if it dies.</p></div>
<div id="types" class="category"><h4><a href="#types">Types</a></h4><hr />
    <div class="type"><h3 id="type-agent">agent() = pid()</h3></div>
    <div class="type"><h3 id="type-deadlocks">deadlocks() = [<a href="#type-lock_id" class="seealso">lock_id()</a>]</h3></div>
    <div class="type"><h3 id="type-lock_id">lock_id() = {<a href="#type-oid" class="seealso">oid()</a>, node()}</h3></div>
    <div class="type"><h3 id="type-lock_result">lock_result() = {<a href="#type-lock_status" class="seealso">lock_status()</a>, <a href="#type-deadlocks" class="seealso">deadlocks()</a>}</h3></div>
    <div class="type"><h3 id="type-lock_status">lock_status() = have_all_locks | have_none</h3></div>
    <div class="type"><h3 id="type-mode">mode() = read | write</h3></div>
    <div class="type"><h3 id="type-obj">obj() = {<a href="#type-oid" class="seealso">oid()</a>, <a href="#type-mode" class="seealso">mode()</a>}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {<a href="#type-oid" class="seealso">oid()</a>, <a href="#type-mode" class="seealso">mode()</a>, <a href="#type-where" class="seealso">where()</a>}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {<a href="#type-oid" class="seealso">oid()</a>, <a href="#type-mode" class="seealso">mode()</a>, <a href="#type-where" class="seealso">where()</a>, <a href="#type-req" class="seealso">req()</a>}</h3></div>
    <div class="type"><h3 id="type-objs">objs() = [<a href="#type-obj" class="seealso">obj()</a>]</h3></div>
    <div class="type"><h3 id="type-oid">oid() = [any()]</h3></div>
    <div class="type"><h3 id="type-option">option() = {client, pid()}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {abort_on_deadlock, boolean()}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {await_nodes, boolean()}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {notify, boolean()}</h3></div>
    <div class="type"><h3 id="type-options">options() = <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[{link, boolean()} |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{client, pid()} |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{abort_on_error, boolean()} |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{abort_on_deadlock, boolean()}]</h3></div>
    <div class="type"><h3 id="type-req">req() = any | all | majority | all_alive</h3></div>
    <div class="type"><h3 id="type-transaction_status">transaction_status() = no_locks<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {have_all_locks, list()}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| waiting<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| {cannot_serve, list()}</h3></div>
    <div class="type"><h3 id="type-where">where() = [node()]</h3></div></div>
<div id="functions" class="category"><h4><a href="#functions">Functions</a></h4><hr />
<div class="function">
<h3 id="record_fields/1">record_fields(X1) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="start_link/0">start_link() -&gt; {ok, pid()}</h3>


<div class="description">
<p>Equivalent to <a href="#start_link/1" class="seealso">start_link([])</a>.</p>
</div></div>
<div class="function">
<h3 id="start_link/1">start_link(Options::[option()]) -&gt; {ok, pid()}</h3>


<div class="description">

<p>Starts an agent with options, linking to the client.</p>
 
  <p>Note that even if <code>{link, false}</code> is specified in the Options, this will
  be overridden by <code>{link, true}</code>, implicit in the function name.</p>
 
  <p>Linking is normally not required, as the agent will always monitor the  
client and terminate if the client dies.</p>
 
  <p>See also <a href="#start/1" class="seealso">start/1</a>.</p>
</div></div>
<div class="function">
<h3 id="start/0">start() -&gt; {ok, pid()}</h3>


<div class="description">
<p>Equivalent to <a href="#start/1" class="seealso">start([])</a>.</p>
</div></div>
<div class="function">
<h3 id="start/1">start(Options0::[option()]) -&gt; {ok, pid()}</h3>


<div class="description">

<p>Starts an agent with options.</p>
 
  <p>Options are:</p>
 
  <p>* <code>{client, pid()}</code> - defaults to <code>self()</code>, indicating which process is  
the client. The agent will monitor the client, and only accept lock  
requests from it (this may be extended in future version).</p>
 
  <p>* <code>{link, boolean()}</code> - default: <code>false</code>. Whether to link the current  
process to the agent. This is normally not required, but will have the  
effect that the current process (normally the client) receives an 'EXIT'  
signal if the agent aborts.</p>
 
  <p>* <code>{abort_on_deadlock, boolean()}</code> - default: <code>false</code>. Normally, when
  deadlocks are detected, one agent will be picked to surrender a lock.
  This can be problematic if the client has already been notified that the
  lock has been granted. If <code>{abort_on_deadlock, true}</code>, the agent will
  abort if it would otherwise have had to surrender, <em>and</em> the client  
has been told that the lock has been granted.</p>
 
  <p>* <code>{await_nodes, boolean()}</code> - default: <code>false</code>. If nodes 'disappear'
  (i.e. the locks_server there goes away) and <code>{await_nodes, false}</code>,
  the agent will consider those nodes lost and may abort if the lock
  request(s) cannot be granted without the lost nodes. If <code>{await_nodes,true}</code>,  
the agent will wait for the nodes to reappear, and reclaim the lock(s) when  
they do.</p>
 
  <p>* <code>{notify, boolean()}</code> - default: <code>false</code>. If <code>{notify, true}</code>, the client
  will receive <code>{locks_agent, Agent, Info}</code> messages, where <code>Info</code> is either
  a <code>#locks_info{}</code> record or <code>{have_all_locks, Deadlocks}</code>.</p>
</div></div>
<div class="function">
<h3 id="spawn_agent/1">spawn_agent(Options) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="begin_transaction/1">begin_transaction(Objects::objs()) -&gt; {agent(), lock_result()}</h3>


<div class="description">
<p>Equivalent to <a href="#begin_transaction/2" class="seealso">begin_transaction(Objects, [])</a>.</p>
</div></div>
<div class="function">
<h3 id="begin_transaction/1-1">begin_transaction(Objects::objs(), Opts::options()) -&gt; {agent(), lock_result()}</h3>


<div class="description">

<p>Starts an agent and requests a number of locks at the same time.</p>
 
  <p>For a description of valid options, see <a href="#start/1" class="seealso">start/1</a>.</p>
 
  <p>This function will return once the given lock requests have been granted,
  or exit if they cannot be. If no initial lock requests are given, the
  function will not wait at all, but return directly.</p>
</div></div>
<div class="function">
<h3 id="await_all_locks/1">await_all_locks(Agent::agent()) -&gt; lock_result()</h3>


<div class="description">

<p>Waits for all active lock requests to be granted.</p>
 
  <p>This function will return once all active lock requests have been granted.
  If the agent determines that they cannot be granted, or if it has been
  instructed to abort, this function will raise an exception.</p>
</div></div>
<div class="function">
<h3 id="end_transaction/1">end_transaction(Agent::agent()) -&gt; ok</h3>


<div class="description">

<p>Ends the transaction, terminating the agent.</p>
 
  <p>All lock requests issued via the agent will automatically be released.</p>
</div></div>
<div class="function">
<h3 id="lock/1">lock(Agent::pid(), Obj::oid()) -&gt; {ok, list()}</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock/1-1">lock(Agent::pid(), Obj::oid(), Mode::mode()) -&gt; {ok, list()}</h3>


<div class="description">
<p>Equivalent to <a href="#lock/6" class="seealso">lock(Agent, Obj, Mode, [node()], all, wait)</a>.</p>
</div></div>
<div class="function">
<h3 id="lock/1-2">lock(Agent::pid(), Obj::oid(), Mode::mode(), Where::[node()]) -&gt; {ok, list()}</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock/1-3">lock(Agent::pid(), Obj::oid(), Mode::mode(), Where::[node()], R::req()) -&gt; {ok, list()}</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="change_flag/3">change_flag(Agent, Option, Bool) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock_nowait/2">lock_nowait(A, O) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock_nowait/3">lock_nowait(A, O, M) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock_nowait/4">lock_nowait(A, O, M, W) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock_nowait/5">lock_nowait(A, O, M, W, R) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="surrender_nowait/4">surrender_nowait(A, O, OtherAgent, Nodes) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock_objects/1">lock_objects(Agent::pid(), Objects::objs()) -&gt; ok</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="lock_info/1">lock_info(Agent) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="transaction_status/1">transaction_status(Agent::agent()) -&gt; transaction_status()</h3>


<div class="description">

<p>Inquire about the current status of the transaction.
  Return values:
  </p><taglist>
  <dt><code>no_locks</code></dt>
    <item><p>No locks have been requested</p></item>
  <dt><code>{have_all_locks, Deadlocks}</code></dt>
    <item><p>All requested locks have been claimed, <code>Deadlocks</code> indicates whether
        any deadlocks were resolved in the process.</p></item>
  <dt><code>waiting</code></dt>
    <item><p>Still waiting for some locks.</p></item>
  <dt><code>{cannot_serve, Objs}</code></dt>
    <item><p>Some lock requests cannot be served, e.g. because some nodes are
        unavailable.</p></item>
  </taglist>
</div></div></div>

<authors>
<aname> </aname>
<email> </email></authors>
      </div>
  </div>

    <script type="text/javascript">
      var CURRENT_ROOT = "../";
    </script>

    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="../erldocs_index.js"></script>
    <script type="text/javascript" src="/erldocs.js"></script>
  </body>
</html>
