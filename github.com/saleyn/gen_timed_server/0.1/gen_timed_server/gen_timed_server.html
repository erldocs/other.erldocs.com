<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>gen_timed_server (gen_timed_server) -  (Erlang Documentation)</title>
    <link href="/erldocs.css" type="text/css" rel="stylesheet"/>
    <link href="/search.xml" rel="search" type="application/opensearchdescription+xml" title="erldocs"/>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-54292016-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="sidebar" class="inactive">
      <input type="text" id="search" autocomplete="off" placeholder="press TAB to search"/>
      <ul id="results"> </ul>
    </div>

    <div id="content">
      <div style="margin:0px; padding:10px 20px;">
        

<h1>gen_timed_server</h1>
<h2 class="modsummary">This module abstracts the process scheduling facility into a
   reusable behavior.</h2>
<div class="description">
<p>This module abstracts the process scheduling facility into a
   reusable behavior.  It implements a behavior that includes features of
   <code>gen_server</code> and <code>supervisor</code> that allows building scheduling
   features to run an instance of <code>gen_server</code> on given days
   of week/months between certain hours of day.  The <code>supervisor</code> part
   of the server handles all scheduling events, and the <code>execution</code>
   part of the server handles spawning a separate process that calls
   <code>handle_run/1</code> callback.
     The server can execute a "daemon" like long-lived functionality
   or some short-lived perioric task that will be rescheduled on the
   following run interval.  The behavior is somewhat similar to
   functionality of <code>cron</code> but designed for scheduling Erlang processes.</p>
  
   Scheduling features include abilities to:
   <list>
   <item><p>Run a server on given days of week between one or more
       range of hours</p></item>
   <item><p>Specify periodic execution. E.g. a task can run every <code>N</code>
       seconds/minutes/hours between given hours of day</p></item>
   <item><p>Limit execution of a server to given days of month specified
       from first day of month or from last day of month</p></item>
   <item><p>Specify task restart strategy that allows restarting the
       scheduled process up until the maximum restart intensity is
       reached expressed in terms of the number of restarts within
       a given number of seconds and allows specifying restart delay
       expressed in seconds.</p></item>
   <item><p>Specify child process shutdown type - immediate or in a given
       interval</p></item>
   <item><p>Log all scheduling events to <code>event_logger</code> using an optional
       custom event report type</p></item>
   </list>
  
   The user module should export the following callbacks (note that
   the signature of these functions is slightly different from
   gen_server's by having an extra <code>Opaque</code> argument. Use <code>get/2</code>
   function to inspect its value):
   <pre class="sh_erlang">     init(Args)
       ==&gt; {ok, State}
           {ok, State, Timeout}
           ignore
           {stop, Reason}
  
     handle_call(Msg, From, State, Opaque)
      ==&gt; {reply, Reply, State}
          {reply, Reply, State, Timeout}
          {noreply, State}
          {noreply, State, Timeout}
          {stop, Reason, Reply, State}
              Reason = normal | shutdown | Term terminate(State) is called
  
     handle_cast(Msg, State, Opaque)
      ==&gt; {noreply, State}
          {noreply, State, Timeout}
          {stop, Reason, State}
                Reason = normal | shutdown | Term terminate(State) is called
  
     handle_info(Info, State, Opaque)
      ==&gt; {noreply, State}
          {noreply, State, Timeout}
          {stop, Reason, State}
                Reason = normal | shutdown | Term, terminate(State) is called
  
     terminate(Reason, State) Let the user module clean up
          always called when server terminates
      ==&gt; ok
  
   The following callbacks happen on start/run/stop of a scheduled
   child process:
  
     handle_start(State, Opaque) -&gt;
      ==&gt; {start, State}        continues with normal start
          {skip, State}         reschedules startup for the next valid interval
          {stop, Reason, State}
  
     handle_run(State) -&gt;
      ==&gt; void()                     when no `no_spawn' option provided
          {ok, Pid} | {stop, Reason} when `no_spawn' option is provided
  
      valid exit values are:
        * normal     - performs normal rescheduling
        * shutdown   - exits the gen_server without any further rescheduing
        * Term       - performs supervised recovery by applying
                       given restart policy
     handle_stop(Action, Reason, State, Opaque) -&gt;
                 Action = continue | stop
      ==&gt; {continue, Reason, State}    continues with default rescheduling
          {stop, Reason, State}</pre>
   Also note that whenever the term <code>supervisor</code> is used in this document
   it refers to the scheduling part of the <code>gen_timed_server</code> behavior
   rather than a separate parent supervisor process.
   <pre class="sh_erlang">     Examples:
       Execute M:handle_run/1 every Monday between 9:30am and 5:00pm:
         gen_timed_server:start_link(M, Args,
             [{schedule, [{mon, [{"9:30:00", "17:00:00"}]}]}], []).
  
       Execute M:handle_run/1 every last two days of a month between
       9:30am and 5:00pm:
         gen_timed_server:start_link(M, Args,
             [{schedule, [{any, [{"9:30:00", "17:00:00"}]}]},
              {include_days, [-1,-2]}], []).
  
       Execute M:handle_run/1 every 5 minutes on every last ten days of
       a month between 1:00am and 9:00pm:
         gen_timed_server:start_link(M, Args,
             [{schedule, [{any, [{"1:00:00", "21:00:00", "00:05:00"}]}]},
              {include_days, [{-1,-10}]}]).
  
       Execute M:handle_run/1 every day except for the first 5 days of
       a month between 1:00am and 9:00pm:
         gen_timed_server:start_link(M, Args,
             [{schedule, [{any, [{"1:00:00", "21:00:00"}]}]},
              {exclude_days, [{1,5}]}]).
  
       Execute M:handle_run/1 every Monday between 9:30am and 5:00pm
       repeating every 30 minutes:
         gen_timed_server:start_link(M, Args,
             [{schedule, [{mon, [{"9:30:00", "17:00:00", "00:30:00"}]}]}]).
  
       Execute M:handle_run/1 every Mon,Tue,Wed between 9:30am and 5:00pm:
         timed_supervisor:start_link({M,F,A},
             [{schedule, [{[mon,tue,wed], [{{9,30,0}, {17,0,0}}]}]}]).
  
       Execute M:handle_run/1 every Mon between 9am and 5pm, and Wed
       between 8am and 9pm:
         gen_timed_server:start_link(M, Args,
             [{schedule, [{mon, [{{9,0,0}, {17,0,0}}]},
                          {wed, [{{8,0,0}, {21,0,0}}]}]}]).
  
       Execute M:handle_run/1 every Monday between 9:00am and 5:00pm, and
       set the maximum restart intensity to 3 failures within 20 seconds
       with delay between restarts of 4 seconds:
         gen_timed_server:start_link(M, Args,
               [{schedule, [{mon, [{"9:00:00", "17:00:00"}]}]},
                {restart, {3, 20, 4}}]).</pre></div>
<div id="types" class="category"><h4><a href="#types">Types</a></h4><hr />
    <div class="type"><h3 id="type-day">day() = mon | tue | wed | thu | fri | sat | sun</h3></div>
    <div class="type"><h3 id="type-hourrange">hourrange() = {FromTime::time(), ToTime::time()} | {FromTime::time(), ToTime::time(), Repeat::time()}</h3></div>
    <div class="type"><h3 id="type-schedule">schedule() = [DaySchedule]</h3></div>
    <div class="type"><h3 id="type-sup_name">sup_name() = atom() | pid()</h3></div>
    <div class="type"><h3 id="type-sup_options">sup_options() = [SupOption]</h3></div>
    <div class="type"><h3 id="type-time">time() = string() | {Hour::integer(), Min::integer(), Sec::integer()}</h3></div>
    <div class="type"><h3 id="type-timespec">timespec() = {Mon::hourrange(), Tue::hourrange(), Wed::hourrange(), Thu::hourrange(), Fri::hourrange(), Sat::hourrange(), Sun::hourrange()}</h3></div></div>
<div id="functions" class="category"><h4><a href="#functions">Functions</a></h4><hr />
<div class="function">
<h3 id="start_link/1">start_link(Name::sup_name(), Mod::Module, Args, SupOpts::sup_options(), GenSrvOpts::Options) -&gt; {ok, Pid::pid()} | ignore | {error, Error}</h3>


<div class="description">

<p>Creates a timed server process as part of a supervision tree.  This
       function will, among other things, ensure that the supervisor is
       linked to the calling process (its supervisor).  The child process
       started by <code>{M, F, A}</code> will only be run between time windows
       specified by the <code>schedule</code> option.  <code>RestartSpec</code> option allows
       to define MaxR number of restarts within MaxTime window
       (in seconds) with a restart Delay seconds.  When maximum restart
       intensity is reached and the process keeps failing, this supervisor
       process fails with reason <code>reached_max_restart_intensity</code>. Note that
       default <code>restart</code> option is <code>{_MaxR = 0, _MaxT = 1, _Delay = 0}</code>
       meaning that the child process won't be auto restarted.
 </p>
<p><em>See also:</em> <a href="../http///www.erlang.org/edoc/doc/stdlib/doc/supervisor.xml.html" class="seealso">//stdlib/supervisor</a>.</p>
</div></div>
<div class="function">
<h3 id="start_link/1-1">start_link(Mod::atom(), Args::list(), SupOpts::sup_options(), GenSrvOpts::list()) -&gt; {ok, Pid::pid()} | ignore | {error, Error}</h3>


<div class="description">

<p>Creates a timed server as part of supervision tree without
       a registered name.</p>
<p><em>See also:</em> <a href="#start_link/3" class="seealso">start_link/3</a>.</p>
</div></div>
<div class="function">
<h3 id="start/5">start(Name, Mod, Args, SupOpts, GenSrvOpts) -&gt; term()
</h3>


<div class="description">

<p>Creates a timed server process outside of supervision tree.</p>
<p><em>See also:</em> <a href="#start_link/3" class="seealso">start_link/3</a>.</p>
</div></div>
<div class="function">
<h3 id="start/4">start(Mod, Args, SupOpts, GenSrvOpts) -&gt; term()
</h3>


<div class="description">

<p>Creates a timed server process outside of supervision tree.</p>
<p><em>See also:</em> <a href="#start_link/3" class="seealso">start_link/3</a>.</p>
</div></div>
<div class="function">
<h3 id="info/1">info(Name) -&gt; State::list()</h3>


<div class="description">

<p>Return supervisor's internal state.</p>
</div></div>
<div class="function">
<h3 id="swap_options/2">swap_options(Name, SupOptions::sup_options()) -&gt; ok | {error, Why}</h3>


<div class="description">

<p>Replace child's specification and restart (according to schedule)
       the child process if it was running.</p>
</div></div>
<div class="function">
<h3 id="reschedule/1">reschedule(Name) -&gt; ok | {error, Why}</h3>


<div class="description">

<p>Terminate child with reason <code>shutdown</code> and reschedule it for
       the next interval in the schedule specification.</p>
</div></div>
<div class="function">
<h3 id="restart/1">restart(Name) -&gt; ok | stopped</h3>


<div class="description">

<p>Bounce child process with reason <code>shutdown</code>.  If process is not
       scheduled to run, nothing happens and the supervisor will activate
       it at the future scheduled time.</p>
</div></div>
<div class="function">
<h3 id="force_start/1">force_start(Name) -&gt; ok | stopped | {error, Reason}</h3>


<div class="description">

<p>Force immediate start of child process if it is not currently
       running irrespective of the scheduling options.</p>
</div></div>
<div class="function">
<h3 id="get_child_pid/1">get_child_pid(Name) -&gt; pid() | undefined</h3>


<div class="description">

<p>Return the pid of the process executing handle_run/2 callback or
       <code>undefined</code> if the process is not running.</p>
</div></div>
<div class="function">
<h3 id="call/2">call(Name, Cmd) -&gt; term()
</h3>


<div class="description">
<p>Equivalent to <a href="gen_server.xml.html#call/2" class="seealso">gen_server:call(Name, Cmd)</a>.</p>
</div></div>
<div class="function">
<h3 id="call/3">call(Name, Cmd, Timeout) -&gt; term()
</h3>


<div class="description">
<p>Equivalent to <a href="gen_server.xml.html#call/3" class="seealso">gen_server:call(Name, Cmd, Timeout)</a>.</p>
</div></div>
<div class="function">
<h3 id="cast/2">cast(Name, Cmd) -&gt; term()
</h3>


<div class="description">
<p>Equivalent to <a href="gen_server.xml.html#cast/2" class="seealso">gen_server:cast(Name, Cmd)</a>.</p>
</div></div>
<div class="function">
<h3 id="cast/3">cast(Name, Cmd, Timeout) -&gt; term()
</h3>


<div class="description">
<p>Equivalent to <a href="gen_server.xml.html#cast/3" class="seealso">gen_server:cast(Name, Cmd, Timeout)</a>.</p>
</div></div>
<div class="function">
<h3 id="reply/2">reply(Client, Reply) -&gt; term()
</h3>


<div class="description">
<p>Equivalent to <a href="gen_server.xml.html#reply/2" class="seealso">gen_server:reply(Client, Reply)</a>.</p>
</div></div>
<div class="function">
<h3 id="full_schedule/0">full_schedule() -&gt; schedule()</h3>


<div class="description">

<p>Return a schedule covering all days of week / hours of day.  This
       is a convenience function for a default schedule value.</p>
</div></div>
<div class="function">
<h3 id="weekdays/0">weekdays() -&gt; [Day::atom()]</h3>


<div class="description">

<p>Return a list of weekday atoms</p>
</div></div>
<div class="function">
<h3 id="get/1">get(Item::atom(), State::Opaque) -&gt; Value | [Value]</h3>


<div class="description">

<p>Get an item from <code>Opaque</code> structure passed to most of behavior
       callbacks.  If <code>Item</code> is <code>all</code> then <code>[Value]</code> list is returned.</p>
</div></div>
<div class="function">
<h3 id="split_options/1">split_options(Options::list()) -&gt; {SupOptions::sup_options(), Rest}</h3>


<div class="description">

<p>Separated gen_timed_server's supervision options from other
       options found in the list.</p>
</div></div>
<div class="function">
<h3 id="format_valid_days/1">format_valid_days(Int::{FromBegin::integer(), FromEnd::integer()}) -&gt; ValidDays</h3>

<ul class="type">
<li><code>ValidDays = [ValidDay]</code></li><li><code>ValidDay = {FromDay::integer(), ToDay::integer()} | Day</code></li><li><code>Day = integer()</code></li></ul>
<div class="description">

<p>Convert a <code>DaysMask</code> stored in <code>#state.valid_days</code> to a list
       of days or day ranges with positive values indicating days of
       month from the beginning of a month, and negative values - from
       the end of a month.</p>
</div></div>
<div class="function">
<h3 id="validate_schedule/1">validate_schedule(DaySpecs::schedule()) -&gt; {'$ts$', Result::timespec()}</h3>


<div class="description">

<p>Validate day/time specification. Thow error on invalid specification
       format.</p>
</div></div>
<div class="function">
<h3 id="parse_time/1">parse_time(Time) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="now_to_datetime/1">now_to_datetime(Now) -&gt; undefined | {Date, Time}</h3>

<ul class="type">
<li><code>Now = undefined | now()</code></li></ul>
<div class="description">

<p>Same as <code>calendar:now_to_local_time/1</code> but can accept <code>undefined</code>.</p>
</div></div>
<div class="function">
<h3 id="format_time/1">format_time(X1::Time) -&gt; string()</h3>


<div class="description">

<p>Format time as "HH:MM:SS".</p>
</div></div>
<div class="function">
<h3 id="day_of_the_week/1">day_of_the_week(X1) -&gt; term()
</h3>


<div class="description">
 </div></div>
<div class="function">
<h3 id="dow_to_string/1">dow_to_string(DayOfWeek::integer()) -&gt; Result::string()</h3>


<div class="description">

<p>Converts a day of week to a string. Special case: when argument
       is 0, it returns "Today".</p>
</div></div>
<div class="function">
<h3 id="print_timespec/1">print_timespec(TimeSpec::timespec()) -&gt; Result::string()</h3>


<div class="description">

<p>Converts a validated timespec() into a printable string.</p>
</div></div></div>

<authors>

<aname>Serge Aleynikov</aname>
<email>saleyn@gmail.com</email></authors>
      </div>
  </div>

    <script type="text/javascript">
      var CURRENT_ROOT = "../";
    </script>

    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="../erldocs_index.js"></script>
    <script type="text/javascript" src="/erldocs.js"></script>
  </body>
</html>
