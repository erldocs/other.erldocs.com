<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>ecron (ecron) -  (Erlang Documentation)</title>
    <link href="/erldocs.css" type="text/css" rel="stylesheet"/>
    <link href="/search.xml" rel="search" type="application/opensearchdescription+xml" title="erldocs"/>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-54292016-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="sidebar" class="inactive">
      <input type="text" id="search" autocomplete="off" placeholder="press TAB to search"/>
      <ul id="results"> </ul>
    </div>

    <div id="content">
      <div style="margin:0px; padding:10px 20px;">
        

<h1>ecron</h1>
<h2 class="modsummary">The Ecron API module.</h2>
<div class="description">
<p>The Ecron API module.</p>
 
  <p>The Ecron application executes scheduled functions.
  A list of functions to execute might be specified in the ecron application
  resource file as value of the <code>scheduled</code> environment variable.</p>
 
  <p>Each entry specifies a job and must contain the scheduled time and a MFA
  tuple <code>{Module, Function, Arguments}</code>.
  It's also possible to configure options for a retry algorithm to run in case
  MFA fails.
  </p><pre class="sh_erlang">
  Job =  {{Date, Time}, MFA, Retry, Seconds} |
         {{Date, Time}, MFA}
  </pre><p>
  <code>Seconds = integer()</code> is the retry interval.</p>
 
  <p><code>Retry = integer() | infinity</code> is the number of times to retry.</p>
 
 
  <p>Example of ecron.app
  </p><pre class="sh_erlang">
  ...
  {env,[{scheduled,
         [{{{ '*', '*', '*'}, {0 ,0,0}}, {my_mod, my_fun1, Args}},
          {{{ '*', 12 ,  25}, {0 ,0,0}}, {my_mod, my_fun2, Args}},
          {{{ '*', 1  ,  1 }, {0 ,0,0}}, {my_mod, my_fun3, Args}, infinity, 60},
          {{{2010, 1  ,  1 }, {12,0,0}}, {my_mod, my_fun3, Args}},
          {{{ '*', 12 ,last}, {0 ,0,0}}, {my_mod, my_fun4, Args}]}]},
  ...
  </pre><p>
  Once the ecron application is started, it's possible to dynamically add new
  jobs using the <code>ecron:insert/2</code> or  <code>ecron:insert/4</code>  
API.</p>
 
  <p>The MFA is executed when a task is set to run.
  The MFA has to return <code>ok</code>, <code>{ok, Data}</code>, <code>{apply, fun()}</code>
  or <code>{error, Reason}</code>.
  If <code>{error, Reason}</code> is returned and the job was defined with retry options  
(Retry and Seconds were specified together with the MFA) then ecron will try  
to execute MFA later according to the given configuration.</p>
 
  <p>The MFA may return <code>{apply, fun()}</code> where <code>fun()</code> has arity zero.</p>
 
  <p><code>fun</code> will be immediately executed after MFA execution.
  The <code>fun</code> has to return <code>ok</code>, <code>{ok, Data}</code> or <code>{error, Reason}</code>.</p>
 
  <p>If the MFA or <code>fun</code> terminates abnormally or returns an invalid
  data type (not <code>ok</code>, <code>{ok, Data}</code> or <code>{error, Reason}</code>), an event  
is forwarded to the event manager and no retries are executed.</p>
 
  <p>If the return value of the fun is <code>{error, Reason}</code> and retry
  options were given in the job specification then the <code>fun</code> is  
rescheduled to be executed after the configurable amount of time.</p>
 
  <p>Data which does not change between retries of the <code>fun</code>
  must be calculated outside the scope of the <code>fun</code>.
  Data which changes between retries has to be calculated within the scope
  of the <code>fun</code>.<br />  
In the following example, ScheduleTime will change each time the function is  
scheduled, while ExecutionTime will change for every retry. If static data  
has to persist across calls or retries, this is done through a function in  
the MFA or the fun.</p>
 
  <pre class="sh_erlang">
  print() -&gt;
    ScheduledTime = time(),
    {apply, fun() -&gt;
        ExecutionTime = time(),
        io:format("Scheduled:~p~n",[ScheduledTime]),
        io:format("Execution:~p~n",[ExecutionTime]),
        {error, retry}
    end}.
  </pre><p>  
Event handlers may be configured in the application resource file specifying  
for each of them, a tuple as the following:</p>
 
  <pre class="sh_erlang">{Handler, Args}
 
  Handler = Module | {Module,Id}
  Module = atom()
  Id = term()
  Args = term()
  </pre><p>
  <code>Module:init/1</code> will be called to initiate the event handler and
  its internal state<br /><br />
  Example of ecron.app
  </p><pre class="sh_erlang">
  ...
  {env, [{event_handlers, [{ecron_event, []}]}]},
  ...
  </pre><p>
  The API <code>add_event_handler/2</code> and
  <code>delete_event_handler/1</code>  
allow user to dynamically add and remove event handlers.</p>
 
  <p>All the configured event handlers will receive the following events:</p>
 
  <p><code>{mfa_result, Result, {Schedule, {M, F, A}}, DueDateTime, ExecutionDateTime}</code>   
when MFA is  executed.</p>
 
  <p><code>{fun_result, Result, {Schedule, {M, F, A}}, DueDateTime, ExecutionDateTime}</code>
  when <code>fun</code> is executed.</p>
 
  <p><code>{retry, {Schedule, MFA}, Fun, DueDateTime}</code>
  when MFA, or <code>fun</code>, is rescheduled to be executed later after a failure.</p>
 
  <p><code>{max_retry, {Schedule, MFA}, Fun, DueDateTime}</code> when MFA,
  or <code>fun</code> has reached maximum number of retry specified when  
the job was inserted.</p>
 
  <p><code>Result</code> is the return value of MFA or <code>fun</code>.
   If an exception occurs during evaluation of MFA, or <code>fun</code>, then
  it's caught and sent in the event.
  (E.g. <code>Result = {'EXIT',{Reason,Stack}}</code>).</p>
 
  <p><code>Schedule = {Date, Time}</code> as given when the job was inserted, E.g.
  <code> {{'*','*','*'}, {0,0,0}}</code><br />
  <code>DueDateTime = {Date, Time}</code> is the exact Date and Time when the MFA,
  or the <code>fun</code>, was supposed to run.
   E.g. <code>{{2010,1,1}, {0,0,0}}</code><br />
  <code>ExecutionDateTime = {Date, Time}</code> is the exact Date and Time
  when the MFA, or the <code>fun</code>, was executed.<br /><br /><br />
  If a node is restarted while there are jobs in the list then these jobs are
  not lost. When Ecron starts it takes a list of scheduled MFA from the
  environment variable <code>scheduled</code> and inserts them into a persistent table
  (mnesia). If an entry of the scheduled MFA specifies the same parameters
  values of a job already present in the table then the entry won't be inserted
  avoiding duplicated jobs. <br />
  No duplicated are removed from the MFA list configured in the <code>scheduled</code> variable.
 </p></div>
<div id="functions" class="category"><h4><a href="#functions">Functions</a></h4><hr />
<div class="function">
<h3 id="install/0">install() -&gt; ok</h3>


<div class="description">

<p>Create mnesia tables on those nodes where disc_copies resides according
  to the schema. <br />
  Before starting the <code>ecron</code> application
   for the first time a new database must be created, <code>mnesia:create_schema/1</code> and tables created by <code>ecron:install/0</code> or
   <code>ecron:install/1</code><br />
  E.g. <br />
  </p><pre class="sh_erlang">
  &gt;mnesia:create_schema([node()]).
  &gt;mnesia:start().
  &gt;ecron:install().
  </pre>
</div></div>
<div class="function">
<h3 id="install/1">install(Nodes) -&gt; ok</h3>


<div class="description">

<p>Create mnesia tables on Nodes.</p>
</div></div>
<div class="function">
<h3 id="add_event_handler/2">add_event_handler(Handler, Args) -&gt; {ok, Pid} | {error, Reason}</h3>

<ul class="type">
<li><code>Handler = Module | {Module, Id}</code></li><li><code>Module = atom()</code></li><li><code>Id = term()</code></li><li><code>Args = term()</code></li><li><code>Pid = pid()</code></li></ul>
<div class="description">

<p>Adds a new event handler. The handler is added regardless of whether
  it's already present, thus duplicated handlers may exist.</p>
</div></div>
<div class="function">
<h3 id="delete_event_handler/1">delete_event_handler(Pid) -&gt; ok</h3>

<ul class="type">
<li><code>Pid = pid()</code></li></ul>
<div class="description">

<p>Deletes an event handler. Pid is the pid() returned by
  <code>add_event_handler/2</code>.</p>
</div></div>
<div class="function">
<h3 id="list_event_handlers/0">list_event_handlers() -&gt; [{Pid, Handler}]</h3>

<ul class="type">
<li><code>Handler = Module | {Module, Id}</code></li><li><code>Module = atom()</code></li><li><code>Id = term()</code></li><li><code>Pid = pid()</code></li></ul>
<div class="description">

<p>Returns a list of all event handlers installed by the
       <code>ecron:add_event_handler/2</code> API or configured in the
       <code>event_handlers</code> environment variable.</p>
</div></div>
<div class="function">
<h3 id="insert/2">insert(DateTime, MFA) -&gt; ok</h3>

<ul class="type">
<li><code>DateTime = {Date, Time}</code></li><li><code>Date = {Year, Month, Day} | '*'</code></li><li><code>Time = {Hours, Minutes, Seconds}</code></li><li><code>Year = integer() | '*'</code></li><li><code>Month = integer() | '*'</code></li><li><code>Day = integer() | '*' | last</code></li><li><code>Hours = integer()</code></li><li><code>Minutes = integer()</code></li><li><code>Seconds = integer()</code></li><li><code>MFA = {Module, Function, Args}</code></li></ul>
<div class="description">

<p>Schedules the MFA at the given Date and Time. <br />
  Inserts the MFA into the queue to be scheduled at
  {Year,Month, Day},{Hours, Minutes,Seconds}<br />
  </p><pre class="sh_erlang">
  Month = 1..12 | '*'
  Day = 1..31 | '*' | last
  Hours = 0..23
  Minutes = 0..59
  Seconds = 0..59
  </pre><p>
  If <code>Day = last</code> then the MFA will be executed last day of the month.</p>
 
  <p><code>{'*', Time}</code> runs the MFA every day at the given time and it's
  the same as writing <code>{{'*','*','*'}, Time}</code>.</p>
 
  <p><code>{{'*', '*', Day}, Time}</code> runs the MFA every month at the given
  Day and Time. It must be <code>Day = 1..28 | last</code></p>
 
  <p><code>{{'*', Month, Day}, Time}</code> runs the MFA every year at the given
  Month, Day and Time. Day must be valid for the given month or the atom
  <code>last</code>.
  If <code>Month = 2</code> then it must be <code>Day = 1..28 | last</code></p>
 
  <p>Combinations of the format <code>{'*', Month, '*'}</code> are not allowed.</p>
 
  <p><code>{{Year, Month, Day}, Time}</code> runs the MFA at the given Date and Time.</p>
 
  <p>Returns <code>{error, Reason}</code> if invalid parameters have been passed.</p>
</div></div>
<div class="function">
<h3 id="insert/4">insert(DateTime, MFA, Retry, Seconds::RetrySeconds) -&gt; ok</h3>

<ul class="type">
<li><code>DateTime = {Date, Time}</code></li><li><code>Date = {Year, Month, Day} | '*'</code></li><li><code>Time = {Hours, Minutes, Seconds}</code></li><li><code>Year = integer() | '*'</code></li><li><code>Month = integer() | '*'</code></li><li><code>Day = integer() | '*' | last</code></li><li><code>Hours = integer()</code></li><li><code>Minutes = integer()</code></li><li><code>Seconds = integer()</code></li><li><code>Retry = integer() | infinity</code></li><li><code>RetrySeconds = integer()</code></li><li><code>MFA = {Module, Function, Args}</code></li></ul>
<div class="description">

<p>Schedules the MFA at the given Date and Time and retry if it fails.</p>
 
       <p>Same description of insert/2. Additionally if MFA returns
       <code>{error, Reason}</code>  ecron will retry to execute
       it after <code>RetrySeconds</code>. The MFA will be rescheduled for a
       maximum of Retry times. If MFA returns <code>{apply, fun()}</code> and the
       return value of <code>fun()</code> is <code>{error, Reason}</code> the
       retry mechanism applies to <code>fun</code>. If Retry is equal to 3
       then MFA will be executed for a maximum of four times. The first time
       when is supposed to run according to the schedule and then three more
       times at interval of RetrySeconds.</p>
</div></div>
<div class="function">
<h3 id="list/0">list() -&gt; JobList</h3>


<div class="description">

<p>Returns a list of job records defined in ecron.hrl</p>
</div></div>
<div class="function">
<h3 id="print_list/0">print_list() -&gt; ok</h3>


<div class="description">

<p>Prints a pretty list of records sorted by Job ID. <br />
  E.g. <br />
  </p><pre class="sh_erlang">
  -----------------------------------------------------------------------
  ID: 208
  Function To Execute: mfa
  Next Execution DateTime: {{2009,11,8},{15,59,54}}
  Scheduled Execution DateTime: {{2009,11,8},{15,59,34}}
  MFA: {ecron_tests,test_function,[fra]}
  Schedule: {{'*','*',8},{15,59,34}}
  Max Retry Times: 4
  Retry Interval: 20
  -----------------------------------------------------------------------
  </pre><p>
  <em>ID</em> is the Job ID and should be used as argument in
  <code>delete/1</code>.<br />
  <em>Function To Execute</em> says if the job refers to the
  MFA or the <code>fun</code> returned by MFA.</p>
 
  <p><em>Next Execution DateTime</em> is the date and time when  
the job will be executed.</p>
 
  <p><em>Scheduled Execution DateTime</em> is the date and time
  when the job was supposed to be executed according to the given
  <code>Schedule</code>.<code>Next Execution DateTime</code> and
  <code>Scheduled Execution DateTime</code> are different if the MFA, or
  the <code>fun</code>, failed and it will be retried later  
(as in the example given above).</p>
 
  <p><em>MFA</em> is a tuple with Module, Function and Arguments as
  given when the job was inserted.<br />
  <em>Schedule</em> is the schedule for the MFA as given when the
  job was insterted.<br />
  <em>Max Retry Times</em> is the number of times ecron will retry to  
execute the job in case of failure. It may be less than the value given  
when the job was inserted if a failure and a retry has already occured.</p>
 
  <p><em>Retry Interval</em> is the number of seconds ecron will wait
  after a failure before retrying to execute the job. It's the value given
  when the job was inserted.</p>
</div></div>
<div class="function">
<h3 id="refresh/0">refresh() -&gt; ok</h3>


<div class="description">

<p>Deletes all jobs and recreates the table from the environment variables.</p>
</div></div>
<div class="function">
<h3 id="execute_all/0">execute_all() -&gt; ok</h3>


<div class="description">

<p>Executes all cron jobs in the queue, irrespective of the time they are
  scheduled to run. This might be used at startup and shutdown, ensuring no
  data is lost and backedup data is handled correctly. <br />
  It asynchronously returns <code>ok</code> and then executes all the jobs
  in parallel. <br />
  No retry will be executed even if the MFA, or the <code>fun</code>, fails
  mechanism is enabled for that job. Also in case of periodic jobs MFA won't
  be rescheduled. Thus the jobs list will always be empty after calling
  <code>execute_all/0</code>.</p>
</div></div>
<div class="function">
<h3 id="delete/1">delete(ID) -&gt; ok</h3>


<div class="description">

<p>Deletes a cron job from the list.
  If the job does not exist, the function still returns ok</p>
<p><em>See also:</em> <a href="#print_list/0" class="seealso">print_list/0</a>.</p>
</div></div>
<div class="function">
<h3 id="delete_all/0">delete_all() -&gt; ok</h3>


<div class="description">

<p>Delete all the scheduled jobs</p>
</div></div></div>

<authors>

<aname>Francesca Gangemi</aname>
<email>francesca.gangemi@erlang-solutions.com</email></authors>
      </div>
  </div>

    <script type="text/javascript">
      var CURRENT_ROOT = "../";
    </script>

    <script type="text/javascript" src="/jquery.js"></script>
    <script type="text/javascript" src="../erldocs_index.js"></script>
    <script type="text/javascript" src="/erldocs.js"></script>
  </body>
</html>
